cat > index.html <<'EOF'
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>StraightBar Lite – Web</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0b0d;color:#ddd;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:10px 14px;font-weight:600;display:flex;gap:10px;align-items:center;justify-content:space-between;background:#141419;border-bottom:1px solid #222}
  .stat{opacity:.9;font-size:.95rem;display:flex;gap:14px}
  .wrap{padding:12px;display:flex;flex-direction:column;gap:12px;max-width:800px;margin:0 auto}
  .panel{background:#141419;border:1px solid #222;border-radius:12px;padding:16px}
  .big{font-size:56px;font-weight:800;letter-spacing:.5px}
  .hint{opacity:.8;margin-top:6px}
  .grid{background:#0f0f14;border-radius:12px;position:relative;height:220px;border:1px solid #222;overflow:hidden}
  canvas{position:absolute;inset:0}
  .row{display:flex;flex-wrap:wrap;gap:8px}
  button,input{font-size:16px;border-radius:10px;border:1px solid #2a2a2f;background:#1a1a22;color:#ddd;padding:10px 14px}
  button.primary{background:#2a5bff;border-color:#2a5bff;color:white}
  .ok{color:#19c37d}.warn{color:#f5a524}.bad{color:#ef4444}
</style>
</head>
<body>
<header>
  <div>StraightBar Lite – <span style="opacity:.8">Web</span></div>
  <div class="stat">
    <span id="statGps">GPS: -</span>
    <span id="statAcc">精度: -</span>
    <span id="statSpd">速度: -</span>
    <span id="statHead">針路: -</span>
  </div>
</header>

<div class="wrap">
  <div class="panel" id="guidance">
    <div style="display:flex;align-items:baseline;gap:12px;flex-wrap:wrap">
      <div id="dir" class="big">--</div>
      <div id="unit" style="font-size:22px;opacity:.85">m</div>
    </div>
    <div class="hint" id="sub">ターゲット: 0本目 / 横ズレ: 0.00m</div>
  </div>

  <div class="grid"><canvas id="vis"></canvas></div>

  <div class="panel">
    <div class="row" style="align-items:center">
      <button class="primary" id="btnStart">計測開始</button>
      <button id="btnStop">停止</button>
      <button id="btnWake">画面常時ON</button>
      <span class="hint">（iPhoneは“ホーム画面に追加”推奨）</span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnA">A点 設定</button>
      <button id="btnB">B点 設定</button>
      <button id="btnClear">A/Bクリア</button>
      <label>スワス幅(m): <input type="number" id="swath" value="3" step="0.5" style="width:90px"></label>
      <button id="prev">&larr; 1本前へ</button>
      <button id="next">1本次へ &rarr;</button>
      <button id="nearest">最寄ライン</button>
    </div>
  </div>
</div>

<script>
(() => {
  let watchId=null, accM=null, spd=0, courseDeg=null;
  let ref=null, A=null, line=null;
  let targetIndex=0, swathW=3, crossTrack=0, headingErr=0, wakeLock=null;

  const statGps=document.getElementById('statGps');
  const statAcc=document.getElementById('statAcc');
  const statSpd=document.getElementById('statSpd');
  const statHead=document.getElementById('statHead');
  const dirEl=document.getElementById('dir');
  const subEl=document.getElementById('sub');
  const canvas=document.getElementById('vis');
  const ctx=canvas.getContext('2d');
  const btnStart=document.getElementById('btnStart');
  const btnStop=document.getElementById('btnStop');
  const btnWake=document.getElementById('btnWake');
  const btnA=document.getElementById('btnA');
  const btnB=document.getElementById('btnB');
  const btnClear=document.getElementById('btnClear');
  const swathInp=document.getElementById('swath');
  const prevBtn=document.getElementById('prev');
  const nextBtn=document.getElementById('next');
  const nearestBtn=document.getElementById('nearest');

  const R=6378137.0;
  function ll2enu(lat,lon,refLat,refLon){
    const dLat=(lat-refLat)*Math.PI/180, dLon=(lon-refLon)*Math.PI/180;
    const mPerDegLat=Math.PI*R/180, mPerDegLon=mPerDegLat*Math.cos(refLat*Math.PI/180);
    return [dLon*mPerDegLon, dLat*mPerDegLat]; // [e, n]
  }
  const dot=(a,b)=>a[0]*b[0]+a[1]*b[1];
  const sub=(a,b)=>[a[0]-b[0],a[1]-b[1]];
  const norm=a=>Math.hypot(a[0],a[1]);
  const normalize=v=>{const L=norm(v)||1; return [v[0]/L,v[1]/L];}
  const angleWrap=x=>{while(x>Math.PI)x-=2*Math.PI;while(x<-Math.PI)x+=2*Math.PI;return x;}

  function resize(){canvas.width=canvas.clientWidth; canvas.height=canvas.clientHeight; draw();}
  window.addEventListener('resize', resize); resize();

  function draw(){
    const w=canvas.width,h=canvas.height; const rangeM=Math.max(3, swathW*1.5); const px=w/(rangeM*2);
    const centerX=w/2 - crossTrack*px;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#0f0f14'; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#202028'; ctx.lineWidth=1;
    for(let i=0;i<6;i++){const x=i*w/6; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    ctx.lineWidth=2;
    for(let k=-5;k<=5;k++){ const x=centerX + k*swathW*px; ctx.strokeStyle = (k===0?'#38bdf8':'#2a2a33'); ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    ctx.strokeStyle='#60a5fa'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(centerX,0); ctx.lineTo(centerX,h); ctx.stroke();
    const absE=Math.abs(crossTrack); ctx.fillStyle=absE<=0.1?'#19c37d':(absE<=0.3?'#f5a524':'#ef4444'); ctx.fillRect(w-8,0,8,h);
  }

  function updatePanels(){
    statGps.textContent = watchId?'GPS: 取得中':'GPS: -';
    statAcc.textContent = '精度: '+(accM==null?'-':`${accM.toFixed(0)}m`);
    statSpd.textContent = '速度: '+(spd?(spd*3.6).toFixed(1)+'km/h':'-');
    statHead.textContent= '針路: '+(courseDeg==null?'-':`${courseDeg.toFixed(0)}°`);
    const sign = crossTrack>0?'左へ':(crossTrack<0?'右へ':'そのまま');
    dirEl.textContent = (crossTrack===0)? '0.00' : `${sign} ${Math.abs(crossTrack).toFixed(2)}`;
    subEl.textContent = `ターゲット: ${targetIndex}本目 / 横ズレ: ${crossTrack.toFixed(2)} m`;
    draw();
  }

  btnStart.addEventListener('click', ()=>{
    if(watchId!=null) return;
    if(!navigator.geolocation){ alert('Geolocation未対応'); return; }
    watchId = navigator.geolocation.watchPosition(p=>{
      const c=p.coords;
      if(!ref) ref={lat:c.latitude, lon:c.longitude};
      accM=c.accuracy??null; spd=(c.speed!=null&&c.speed>0)?c.speed:0; courseDeg=(c.heading!=null&&c.heading>=0)?c.heading:null;

      if(line){
        const pt=ll2enu(c.latitude,c.longitude,ref.lat,ref.lon);
        const p0t=[ line.p0[0]+line.nHat[0]*targetIndex*swathW, line.p0[1]+line.nHat[1]*targetIndex*swathW ];
        crossTrack = dot( sub(pt,p0t), line.nHat );
        const thetaVeh = (courseDeg!=null)? courseDeg*Math.PI/180 : 0;
        headingErr = angleWrap(thetaVeh - line.theta);
      }
      updatePanels();
    }, e=>alert('位置失敗: '+e.message), {enableHighAccuracy:true, maximumAge:0, timeout:5000});
    updatePanels();
  });

  btnStop.addEventListener('click', ()=>{ if(watchId!=null){navigator.geolocation.clearWatch(watchId); watchId=null;} updatePanels(); });

  btnA.addEventListener('click', ()=>{
    if(!ref){ alert('まず計測開始を押してください'); return; }
    navigator.geolocation.getCurrentPosition(p=>{
      ref={lat:p.coords.latitude, lon:p.coords.longitude};
      A=ll2enu(ref.lat, ref.lon, ref.lat, ref.lon); // Aを原点
      line=null; targetIndex=0; crossTrack=0; updatePanels();
    }, e=>alert('A取得失敗: '+e.message), {enableHighAccuracy:true});
  });

  btnB.addEventListener('click', ()=>{
    if(!A){ alert('先にA点を設定してください'); return; }
    navigator.geolocation.getCurrentPosition(p=>{
      const B=ll2enu(p.coords.latitude, p.coords.longitude, ref.lat, ref.lon);
      const v=[B[0]-A[0], B[1]-A[1]]; const L=norm(v);
      if(L<1){ alert('AとBが近すぎ'); return; }
      const dir=normalize(v); const nHat=[-dir[1], dir[0]];
      const theta=Math.atan2(dir[1], dir[0]);
      line={p0:[A[0],A[1]], dir, nHat, theta};
      targetIndex=0; crossTrack=0; updatePanels();
    }, e=>alert('B取得失敗: '+e.message), {enableHighAccuracy:true});
  });

  btnClear.addEventListener('click', ()=>{ line=null; targetIndex=0; crossTrack=0; updatePanels(); });

  swathInp.addEventListener('change', ()=>{ swathW=Math.max(0.1, parseFloat(swathInp.value||'3')); updatePanels(); });
  prevBtn.addEventListener('click', ()=>{ targetIndex--; updatePanels(); });
  nextBtn.addEventListener('click', ()=>{ targetIndex++; updatePanels(); });
  nearestBtn.addEventListener('click', ()=>{ targetIndex=0; updatePanels(); });

  btnWake.addEventListener('click', async ()=>{
    try{
      if(!('wakeLock' in navigator)){ alert('Wake Lock未対応'); return; }
      if(!wakeLock){ wakeLock=await navigator.wakeLock.request('screen'); btnWake.textContent='常時ON: 有効'; }
      else { await wakeLock.release(); wakeLock=null; btnWake.textContent='画面常時ON'; }
    }catch(e){ alert('Wake Lock失敗: '+e.message); }
  });

  updatePanels();
})();
</script>
</body>
</html>
EOF
