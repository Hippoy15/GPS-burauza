<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>StraightBar Lite – Web</title>
<style>
  :root { color-scheme: dark; }
  body{margin:0;background:#0b0b0d;color:#ddd;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:10px 14px;font-weight:600;display:flex;gap:10px;align-items:center;justify-content:space-between;background:#141419;border-bottom:1px solid #222}
  .stat{opacity:.9;font-size:.95rem;display:flex;gap:14px;flex-wrap:wrap}
  .wrap{padding:12px;display:flex;flex-direction:column;gap:12px;max-width:860px;margin:0 auto}
  .panel{background:#141419;border:1px solid #222;border-radius:12px;padding:16px}
  .big{font-size:52px;font-weight:800;letter-spacing:.5px}
  .hint{opacity:.8;margin-top:6px}
  .grid{background:#0f0f14;border-radius:12px;position:relative;height:260px;border:1px solid #222;overflow:hidden}
  canvas{position:absolute;inset:0}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  button,input{font-size:16px;border-radius:10px;border:1px solid #2a2a2f;background:#1a1a22;color:#ddd;padding:10px 14px}
  button.primary{background:#2a5bff;border-color:#2a5bff;color:white}
  input[type="number"]{width:90px}
  .badge{border:1px solid #333;padding:6px 10px;border-radius:999px;font-size:.9rem}
  .ok{color:#19c37d}.warn{color:#f5a524}.bad{color:#ef4444}.muted{opacity:.7}
  .on{background:#19c37d;border-color:#19c37d;color:#0b0b0d}
</style>
</head>
<body>
<header>
  <div>StraightBar Lite – <span class="muted">Web</span></div>
  <div class="stat">
    <span id="statGps">GPS: -</span>
    <span id="statAcc">精度: -</span>
    <span id="statSpd">速度: -</span>
    <span id="statHead">針路: -</span>
    <span id="statAB" class="badge muted">A/B: 未設定</span>
    <span id="statABlen" class="badge muted">AB距離: -</span>
    <span id="statLog" class="badge muted">LOG: 0点</span>
  </div>
</header>

<div class="wrap">
  <!-- ガイダンス -->
  <div class="panel">
    <div style="display:flex;align-items:baseline;gap:14px;flex-wrap:wrap">
      <div id="dir" class="big">--</div>
      <div id="unit" style="font-size:22px;opacity:.85">m</div>
    </div>
    <div class="hint" id="sub">横ズレ: 0.00m / Aから: 0.0m / 沿線距離: 0.0m</div>
  </div>

  <!-- 可視化（中央固定線 + 可動線のみ） -->
  <div class="grid"><canvas id="vis"></canvas></div>

  <!-- 操作 -->
  <div class="panel">
    <div class="row">
      <button class="primary" id="btnStart">計測開始</button>
      <button id="btnStop">停止</button>
      <button id="btnWake">画面常時ON</button>
      <label>感度(gain):
        <input type="number" id="gain" value="2.0" step="0.1" />
      </label>
      <span id="stateBadge" class="badge muted">待機中</span>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnA">A点 設定</button>
      <button id="btnB">B点 設定</button>
      <button id="btnClear">A/Bクリア</button>
      <button id="logToggle">ログ記録: OFF</button>
      <button id="logDownload">CSVダウンロード</button>
    </div>
  </div>
</div>

<script>
// ========== ユーティリティ ==========
function ll2enu(lat, lon, lat0, lon0){
  const R = 6378137;
  const dLat = (lat-lat0)*Math.PI/180;
  const dLon = (lon-lon0)*Math.PI/180;
  const x = dLon*Math.cos((lat+lat0)/2*Math.PI/180)*R;
  const y = dLat*R;
  return [x,y];
}
function norm(v){ return Math.sqrt(v[0]*v[0]+v[1]*v[1]); }
function normalize(v){ const n=norm(v); return [v[0]/n,v[1]/n]; }

// ========== 状態 ==========
let watchId=null, ref=null, A_ll=null, B_ll=null, line=null;
let crossTrack=0, alongTrack=0, settingA=false, settingB=false;
let gain=10; // 線の動きの倍率（あとで調整可）

// ログ
let logging=false, log=[];

// ========== ログ記録 ==========
function addLog(c,spd,courseDeg,distFromA){
  if(logging){
    log.push({
      t:new Date().toISOString(),
      lat:c.latitude, lon:c.longitude, acc:c.accuracy,
      speed:spd, heading:courseDeg,
      cross:crossTrack, along:alongTrack, distA:distFromA,
      abSet:!!line, gain:gain
    });
  }
}
function downloadLog(){
  const header='t,lat,lon,acc_m,speed_mps,heading_deg,cross_m,along_m,distA_m,AB_set,gain\n';
  const rows=log.map(r =>
    `${r.t},${r.lat},${r.lon},${r.acc ?? ''},${r.speed ?? ''},${r.heading ?? ''},${r.cross.toFixed(3)},${r.along.toFixed(3)},${r.distA.toFixed(3)},${r.abSet},${r.gain}`
  ).join('\n');
  const blob=new Blob([header+rows],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`straightbar_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// ========== UI 更新 ==========
function updatePanels(){
  const st=document.getElementById('status');
  let msg='';
  if(settingA) msg='A点設定中...';
  else if(settingB) msg='B点設定中...';
  else if(line) msg=`AB設定済: 横ズレ=${crossTrack.toFixed(2)} m, Aから=${alongTrack.toFixed(1)} m`;
  else msg='待機中';
  st.textContent=msg;

  // 線の描画
  const cvs=document.getElementById('cv');
  const ctx=cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);

  // 真ん中の基準線
  ctx.beginPath();
  ctx.moveTo(cvs.width/2,0);
  ctx.lineTo(cvs.width/2,cvs.height);
  ctx.lineWidth=4;
  ctx.strokeStyle='gray';
  ctx.stroke();

  // 動く線（横ズレに比例）
  if(line){
    const dx=crossTrack*gain; // 横ズレを拡大
    ctx.beginPath();
    ctx.moveTo(cvs.width/2+dx,0);
    ctx.lineTo(cvs.width/2+dx,cvs.height);
    ctx.lineWidth=6;
    ctx.strokeStyle=(Math.abs(crossTrack)<1.0)?'lime':'red';
    ctx.stroke();
  }
}

// ========== Aボタン ==========
btnA.addEventListener('click', ()=>{
  settingA=true; updatePanels();
  navigator.geolocation.getCurrentPosition(c=>{
    A_ll={lat:c.coords.latitude,lon:c.coords.longitude};
    ref={lat:A_ll.lat,lon:A_ll.lon};
    settingA=false; updatePanels();
  },err=>{ alert('A失敗:'+err.message); settingA=false; updatePanels(); },
  {enableHighAccuracy:true});
});

// ========== Bボタン（改良版） ==========
// 新しいB点測位関数
async function getFreshPositionForB({durationMs=2000, accLimit=12} = {}){
  return new Promise((resolve,reject)=>{
    const samples=[]; const start=Date.now(); let done=false;
    const wid=navigator.geolocation.watchPosition(
      p=>{
        const c=p.coords; samples.push(c);
        if(c.accuracy && c.accuracy<=accLimit && !done){
          done=true; navigator.geolocation.clearWatch(wid); resolve(c);
        }else if(Date.now()-start>=durationMs && !done){
          done=true; navigator.geolocation.clearWatch(wid);
          let best=samples[0];
          for(const s of samples){ if(s.accuracy<best.accuracy) best=s; }
          resolve(best);
        }
      },
      err=>{ if(!done){done=true; reject(err);} },
      {enableHighAccuracy:true,maximumAge:0,timeout:5000}
    );
  });
}

btnB.addEventListener('click', async ()=>{
  if(!A_ll){ alert('先にA点を設定してください'); return; }
  settingB=true; updatePanels();
  try{
    const c=await getFreshPositionForB({durationMs:2500, accLimit:12});
    B_ll={lat:c.latitude,lon:c.longitude};
    const B=ll2enu(B_ll.lat,B_ll.lon,ref.lat,ref.lon);
    const v=[B[0],B[1]]; const L=norm(v);
    const required=Math.max(5,(c.accuracy??6)+5);
    if(L<required){ settingB=false; updatePanels();
      alert(`Aからの距離が不足:${L.toFixed(1)}m (必要${required.toFixed(1)}m)`); return; }
    const dir=normalize(v); const nHat=[-dir[1],dir[0]];
    line={p0:[0,0],dir,nHat,theta:Math.atan2(dir[1],dir[0])};
    settingB=false; updatePanels();
  }catch(e){ settingB=false; updatePanels(); alert('B失敗:'+e.message); }
});

// ========== クリア ==========
btnClear.addEventListener('click', ()=>{ A_ll=null; B_ll=null; line=null; updatePanels(); });

// ========== 計測開始/停止 ==========
btnStart.addEventListener('click', ()=>{
  if(watchId) return;
  watchId=navigator.geolocation.watchPosition(p=>{
    const c=p.coords;
    let e=[0,0]; let distFromA=0;
    if(ref){ e=ll2enu(c.latitude,c.longitude,ref.lat,ref.lon); }
    if(line){
      const v=[e[0]-line.p0[0],e[1]-line.p0[1]];
      crossTrack=v[0]*line.nHat[0]+v[1]*line.nHat[1];
      alongTrack=v[0]*line.dir[0]+v[1]*line.dir[1];
      distFromA=norm(v);
    }
    updatePanels();
    addLog(c,c.speed,(c.heading??0),distFromA);
  },err=>alert(err.message),{enableHighAccuracy:true});
});

btnStop.addEventListener('click', ()=>{
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
});

// ========== ログボタン ==========
document.getElementById('logToggle').addEventListener('click',()=>{
  logging=!logging; if(logging){ log=[]; }
  document.getElementById('logToggle').textContent=logging?'ログ記録:ON':'ログ記録:OFF';
});
document.getElementById('logDownload').addEventListener('click',downloadLog);

// 初期表示
updatePanels();
</script>
</body>
</html>
